// LICENSE NOTICE ==================================================================================

/**
 * Netzhaut - Web Browser Engine
 * Copyright (C) 2020  Dajo Frey
 * Published under LGPLv3
 */

// INCLUDE =========================================================================================

#include "Main.h"
#include "Serializer.h"
#include "Util.h"

#include "Common/Macro.h"
#include NH_WEBIDL_SERIALIZER_FLOW
#include NH_WEBIDL_SERIALIZER_DEFAULT_CHECK

#include <stddef.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include <unistd.h>

// DECLARE =========================================================================================

#define NH_LICENSE_NOTICE \
    "/**\n * Netzhaut - Web Browser Engine\n * Copyright (C) 2020  Dajo Frey\n * Published under LGPLv3\n *\n * This file was generated by NhWebIDLSerializer\n */\n\n"

// HELPER ==========================================================================================

static NH_WEBIDL_SERIALIZER_RESULT Nh_WebIDLSerializer_getFragmentName(
    NH_BYTE *filepath_p, NH_BYTE *fragmentname_p)
{
NH_WEBIDL_SERIALIZER_BEGIN()

    filepath_p = filepath_p + strlen(filepath_p);
    while (*filepath_p != '/') {filepath_p = filepath_p - 1;}
    filepath_p = filepath_p - 1;
    while (*filepath_p != '/') {filepath_p = filepath_p - 1;}
    filepath_p = filepath_p + 1;
    for (int i = 0; strcmp(filepath_p, ".idl"); ++i) {fragmentname_p[i] = *filepath_p; filepath_p = filepath_p + 1;}
    for (int i = 0; i < strlen(fragmentname_p); ++i) {if (fragmentname_p[i] == '/') {fragmentname_p[i] = '_';}}

NH_WEBIDL_SERIALIZER_END(NH_WEBIDL_SERIALIZER_SUCCESS)
}

static NH_BOOL Nh_WebIDLSerializer_hasExtendedAttribute(
    Nh_Array ExtendedAttributes, NH_WEBIDL_SERIALIZER_EXTENDED_ATTRIBUTE type)
{
NH_WEBIDL_SERIALIZER_BEGIN()

    for (int i = 0; i < ExtendedAttributes.length; ++i) {
        Nh_WebIDLSerializer_ExtendedAttribute *ExtendedAttribute_p = 
            &((Nh_WebIDLSerializer_ExtendedAttribute*)ExtendedAttributes.bytes_p)[i];
        if (ExtendedAttribute_p->type == type) {
            NH_WEBIDL_SERIALIZER_END(NH_TRUE)
        }
    }

NH_WEBIDL_SERIALIZER_END(NH_FALSE)
}

// FRAGMENT DATA HEADER ============================================================================

static int fileCount = 0;
static NH_BYTE *files_pp[2048] = {NULL};

static int serializationDataCount = 0;
static Nh_WebIDLSerializer_SerializationData SerializationData_p[2048];

static NH_BOOL Nh_WebIDLSerializer_functionImplemented(
    NH_BYTE *runtimePath_p, NH_BYTE *fragmentName_p, NH_BYTE *operationName_p)
{
NH_WEBIDL_SERIALIZER_BEGIN()

    NH_BYTE str_p[1024] = {'\0'};
    strcpy(str_p, runtimePath_p);
    for (int i = strlen(str_p) - 1; str_p[i] != '/'; --i) {str_p[i] = '\0';}

    NH_BYTE tmp_p[1024] = {'\0'};
    strcpy(tmp_p, fragmentName_p);
    for (int i = 0; i < strlen(tmp_p); ++i) {if (tmp_p[i] == '_') {tmp_p[i] = '/';}}
    sprintf(str_p + strlen(str_p), "%s.idl.c", tmp_p);

    NH_BYTE *buffer_p = 0;
    long length;

    FILE *f = fopen(str_p, "r");
    if (f == NULL) {NH_WEBIDL_SERIALIZER_END(NH_FALSE)}

    fseek (f, 0, SEEK_END);
    length = ftell(f);
    fseek (f, 0, SEEK_SET);

    if (length > 0)
    {
        buffer_p = malloc(sizeof(NH_BYTE) * (length + 1));
        if (buffer_p) {fread(buffer_p, 1, length, f);}
        buffer_p[length] = '\0';

        sprintf(str_p, "Nh_WebIDLSerializer_%s_%s(\n", fragmentName_p, operationName_p);
        if (strstr(buffer_p, str_p)) {NH_WEBIDL_SERIALIZER_END(NH_TRUE)}

        free(buffer_p);
    }

    fclose(f);

NH_WEBIDL_SERIALIZER_END(NH_FALSE)
}

static NH_WEBIDL_SERIALIZER_RESULT Nh_WebIDLSerializer_createIncludes(
    FILE *f)
{
NH_WEBIDL_SERIALIZER_BEGIN()

    fprintf(f, "// INCLUDE =========================================================================================\n\n");
    fprintf(f, "#include \"FragmentData.h\"\n\n");

    for (int i = 0; i < fileCount; ++i) 
    {
        NH_BYTE fragmentName_p[1024] = {'\0'};
        Nh_WebIDLSerializer_getFragmentName(files_pp[i], fragmentName_p);

        for (int j = 0; j < strlen(fragmentName_p); ++j) {
            if (fragmentName_p[j] == '_') {
                fragmentName_p[j] = '/';
            }
        }

        fprintf(f,"#include \"../%s.idl.h\"\n", fragmentName_p);
    }

NH_WEBIDL_SERIALIZER_DIAGNOSTIC_END(NH_WEBIDL_SERIALIZER_SUCCESS)
}

static NH_WEBIDL_SERIALIZER_RESULT Nh_WebIDLSerializer_createFragmentNames(
    FILE *f, NH_BOOL asString)
{
NH_WEBIDL_SERIALIZER_BEGIN()

    if (asString) {
        fprintf(f, "\n// FRAGMENT NAMES ==================================================================================\n\n");
        fprintf(f, "const NH_BYTE *NH_WEBIDL_SERIALIZER_FRAGMENT_NAMES_PP[] = {\n");
    }
    else {
        fprintf(f, "\n// FRAGMENTS =======================================================================================\n\n");
        fprintf(f, "unsigned NH_BYTE *NH_WEBIDL_SERIALIZER_FRAGMENTS_PP[] = {\n");
    }

    for (int i = 0; i < fileCount; ++i) 
    {
        NH_BYTE fragmentName_p[1024] = {'\0'}, *p;
        Nh_WebIDLSerializer_getFragmentName(files_pp[i], fragmentName_p);
        fprintf(f, asString ? "    \"%s\",\n" : "    Nh_WebIDLSerializer_%s_p,\n", fragmentName_p);
    }

    fprintf(f, "};\n");

    if (asString) {
        fprintf(f, "\nsize_t NH_WEBIDL_SERIALIZER_FRAGMENT_NAMES_PP_COUNT = sizeof(NH_WEBIDL_SERIALIZER_FRAGMENT_NAMES_PP) / sizeof(NH_WEBIDL_SERIALIZER_FRAGMENT_NAMES_PP[0]);\n");
    }
    else {
        fprintf(f, "\nsize_t NH_WEBIDL_SERIALIZER_FRAGMENTS_PP_COUNT = sizeof(NH_WEBIDL_SERIALIZER_FRAGMENTS_PP) / sizeof(NH_WEBIDL_SERIALIZER_FRAGMENTS_PP[0]);\n");
    }

NH_WEBIDL_SERIALIZER_DIAGNOSTIC_END(NH_WEBIDL_SERIALIZER_SUCCESS)
}

static NH_WEBIDL_SERIALIZER_RESULT Nh_WebIDLSerializer_createFragmentFunctions(
    FILE *f, NH_BYTE *runtimePath_p, NH_BOOL asString)
{
NH_WEBIDL_SERIALIZER_BEGIN()

    if (asString) {
        fprintf(f, "\n// FRAGMENT FUNCTION NAMES =========================================================================\n\n");
        fprintf(f, "const NH_BYTE *NH_WEBIDL_SERIALIZER_FRAGMENT_FUNCTION_NAMES_PP[] = {");
    }
    else {
        fprintf(f, "\n// FRAGMENT FUNCTIONS ==============================================================================\n\n");
        fprintf(f, "Nh_WebIDLSerializer_Result (*NH_WEBIDL_SERIALIZER_FRAGMENT_FUNCTIONS_PP[]) (Nh_ECMAScript_Object *This_p, Nh_List Arguments) = {");
    }

    for (int i = 0; i < serializationDataCount; ++i) 
    {
        Nh_WebIDLSerializer_Fragment Fragment = SerializationData_p[i].Fragment;

        NH_BYTE fragmentName_p[1024] = {'\0'};
        Nh_WebIDLSerializer_getFragmentName(files_pp[i], fragmentName_p);

        for (int j = 0; j < Fragment.definitionCount; ++j)
        {
            switch (Fragment.Definitions_p[j].type)
            {
                case NH_WEBIDL_SERIALIZER_DEFINITION_CALLBACK           : break; 
                case NH_WEBIDL_SERIALIZER_DEFINITION_CALLBACK_INTERFACE : break;
                case NH_WEBIDL_SERIALIZER_DEFINITION_INTERFACE          : 
                {
                    Nh_WebIDLSerializer_Interface *Interface_p = Fragment.Definitions_p[j].data_p;
                    for (int k = 0; k < Interface_p->Operations.length; ++k)
                    {
                        Nh_WebIDLSerializer_Operation *Operation_p = &((Nh_WebIDLSerializer_Operation*)Interface_p->Operations.bytes_p)[k];
                        if (Nh_WebIDLSerializer_functionImplemented(runtimePath_p, fragmentName_p, Operation_p->name_p)) {
                            fprintf(f, asString ? "\n    \"%s_%s\"," : "\n    Nh_WebIDLSerializer_%s_%s,", fragmentName_p, Operation_p->name_p);
                        }
                        else {
                            fprintf(f, asString ? "\n//    \"%s_%s\"," : "\n//    Nh_WebIDLSerializer_%s_%s,", fragmentName_p, Operation_p->name_p);
                        }
                    } 
                    break;
                }
                case NH_WEBIDL_SERIALIZER_DEFINITION_INTERFACE_MIXIN    : break; 
                case NH_WEBIDL_SERIALIZER_DEFINITION_MIXIN              : break;
                case NH_WEBIDL_SERIALIZER_DEFINITION_NAMESPACE          : break;
                case NH_WEBIDL_SERIALIZER_DEFINITION_PARTIAL            : break;
                case NH_WEBIDL_SERIALIZER_DEFINITION_DICTIONARY         : break; 
                case NH_WEBIDL_SERIALIZER_DEFINITION_ENUM               : break;
                case NH_WEBIDL_SERIALIZER_DEFINITION_TYPEDEF            : break;
                case NH_WEBIDL_SERIALIZER_DEFINITION_INCLUDES_STATEMENT : break;
            }
        }
    }

    fprintf(f, "\n};\n");

    if (asString) {
        fprintf(f, "\nsize_t NH_WEBIDL_SERIALIZER_FRAGMENT_FUNCTION_NAMES_PP_COUNT = sizeof(NH_WEBIDL_SERIALIZER_FRAGMENT_FUNCTION_NAMES_PP) / sizeof(NH_WEBIDL_SERIALIZER_FRAGMENT_FUNCTION_NAMES_PP[0]);\n");
    }
    else {
        fprintf(f, "\nsize_t NH_WEBIDL_SERIALIZER_FRAGMENT_FUNCTIONS_PP_COUNT = sizeof(NH_WEBIDL_SERIALIZER_FRAGMENT_FUNCTIONS_PP) / sizeof(NH_WEBIDL_SERIALIZER_FRAGMENT_FUNCTIONS_PP[0]);\n");
    }

NH_WEBIDL_SERIALIZER_DIAGNOSTIC_END(NH_WEBIDL_SERIALIZER_SUCCESS)
}

static NH_WEBIDL_SERIALIZER_RESULT Nh_WebIDLSerializer_createBindData(
    NH_BYTE *runtimePath_p)
{
NH_WEBIDL_SERIALIZER_BEGIN()

    NH_BYTE filepath_p[1024] = {'\0'};
    sprintf(filepath_p, "%s/FragmentData.c", runtimePath_p);

    FILE *f = fopen(filepath_p, "w");
    if (f == NULL)
    {
        printf("Error opening file!\n");
        exit(1);
    }

    fprintf(f, "// LICENSE NOTICE ==================================================================================\n\n");
    fprintf(f, NH_LICENSE_NOTICE);

    Nh_WebIDLSerializer_createIncludes(f);
    Nh_WebIDLSerializer_createFragmentNames(f, NH_TRUE);
    Nh_WebIDLSerializer_createFragmentNames(f, NH_FALSE);
    Nh_WebIDLSerializer_createFragmentFunctions(f, runtimePath_p, NH_TRUE);
    Nh_WebIDLSerializer_createFragmentFunctions(f, runtimePath_p, NH_FALSE);

    fclose(f);

NH_WEBIDL_SERIALIZER_DIAGNOSTIC_END(NH_WEBIDL_SERIALIZER_SUCCESS)
}

// HEADER ===========================================================================================

static NH_WEBIDL_SERIALIZER_RESULT Nh_WebIDLSerializer_openDeclFile(
    FILE **File_pp, NH_BYTE *fragmentName_p, NH_BYTE *outdir_p)
{
NH_WEBIDL_SERIALIZER_BEGIN()

    NH_BYTE *shortName_p = NULL;
    for (int i = 0; i < strlen(fragmentName_p); ++i) {
        if (fragmentName_p[i] == '_') {shortName_p = &fragmentName_p[i + 1]; break;}
    }
    NH_WEBIDL_SERIALIZER_CHECK_NULL(shortName_p)

    NH_BYTE outfilepath_p[1024] = {'\0'};
    sprintf(outfilepath_p, "%s/%s.h", outdir_p, shortName_p);

    *File_pp = fopen(outfilepath_p, "w");
    NH_WEBIDL_SERIALIZER_CHECK_NULL(*File_pp)

    NH_BYTE fragmentNameUpper_p[1024] = {'\0'};
    for (int i = 0; i < strlen(fragmentName_p); ++i) {
        fragmentNameUpper_p[i] = toupper(fragmentName_p[i]);
    }

    fprintf(*File_pp,"#ifndef NH_%s_H\n#define NH_%s_H\n\n", fragmentNameUpper_p, fragmentNameUpper_p);

    fprintf(*File_pp,"#ifndef DOXYGEN_SHOULD_SKIP_THIS\n\n");
    fprintf(*File_pp, NH_LICENSE_NOTICE);
    fprintf(*File_pp,"#endif\n\n");

NH_WEBIDL_SERIALIZER_DIAGNOSTIC_END(NH_WEBIDL_SERIALIZER_SUCCESS)
}

static NH_WEBIDL_SERIALIZER_RESULT Nh_WebIDLSerializer_openHexdFile(
    FILE **File_pp, NH_BYTE *fragmentName_p, NH_BYTE *filepath_p)
{
NH_WEBIDL_SERIALIZER_BEGIN()

    NH_BYTE outfilepath_p[1024] = {'\0'};
    sprintf(outfilepath_p, "%s.h", filepath_p);

    *File_pp = fopen(outfilepath_p, "w");
    NH_WEBIDL_SERIALIZER_CHECK_NULL(*File_pp)

    NH_BYTE fragmentNameUpper_p[1024] = {'\0'};
    for (int i = 0; i < strlen(fragmentName_p); ++i) {
        fragmentNameUpper_p[i] = toupper(fragmentName_p[i]);
    }

    fprintf(*File_pp,"#ifndef NH_WEBIDL_%s_H\n#define NH_WEBIDL_%s_H\n\n", fragmentNameUpper_p, fragmentNameUpper_p);
    fprintf(*File_pp,"#ifndef DOXYGEN_SHOULD_SKIP_THIS\n\n");
    fprintf(*File_pp, NH_LICENSE_NOTICE);
    fprintf(*File_pp,"#endif\n\n");

NH_WEBIDL_SERIALIZER_DIAGNOSTIC_END(NH_WEBIDL_SERIALIZER_SUCCESS)
}

static NH_WEBIDL_SERIALIZER_RESULT Nh_WebIDLSerializer_generateHexdFile(
    FILE *File_p, Nh_WebIDLSerializer_SerializationBuffer *Buffer_p, NH_BYTE *fragmentName_p)
{
NH_WEBIDL_SERIALIZER_BEGIN()

    NH_BYTE name_p[1024] = {'\0'};
    sprintf(name_p, "Nh_WebIDL_%s", fragmentName_p);

    fprintf(File_p,"/** @addtogroup NhWebIDLVars\n *  @{\n */\n\n");
    fprintf(File_p, "    unsigned NH_BYTE %s_p[] = {\n", name_p);

    int count = 0, totalCount = 0;
    for (int i = 0; i <= Buffer_p->index; ++i)
    {
        count = 0;
        for (int j = 0; j <= Buffer_p->maxSize; ++j) 
        {
            if (Buffer_p->index == i && (Buffer_p->maxSize - Buffer_p->size) == j) {break;}
            if (count == 0) {fprintf(File_p, "        ");}
            fprintf(
                File_p, 
                Buffer_p->index == i && (Buffer_p->maxSize - Buffer_p->size) == (j + 1) ? "0x%.2x" : "0x%.2x, ", 
                Buffer_p->array_pp[i][j] & 0xff
            );
            if (++count == 12) {fprintf(File_p, "\n"); count = 0;}
            totalCount++;
        }
    } 

    fprintf(File_p, count == 0 ? "    };\n\n" : "\n    };\n\n");
    fprintf(File_p, "    unsigned int %s_len = %d;\n", name_p, totalCount);

NH_WEBIDL_SERIALIZER_END(NH_WEBIDL_SERIALIZER_SUCCESS)
}

static NH_WEBIDL_SERIALIZER_RESULT Nh_WebIDLSerializer_generateDeclFile(
    FILE *File_p, NH_BYTE *fragmentName_p, Nh_WebIDLSerializer_Fragment Fragment)
{
NH_WEBIDL_SERIALIZER_BEGIN()

    fprintf(File_p,"/** @addtogroup NhFunctions Functions\n *  @{\n */\n");

    for (int i = 0; i < Fragment.definitionCount; i++) 
    {
        Nh_WebIDLSerializer_Definition Definition = Fragment.Definitions_p[i];
    
        switch (Definition.type)
        {
            case NH_WEBIDL_SERIALIZER_DEFINITION_CALLBACK           : break; 
            case NH_WEBIDL_SERIALIZER_DEFINITION_CALLBACK_INTERFACE : break;
            case NH_WEBIDL_SERIALIZER_DEFINITION_INTERFACE          : 
            {
                Nh_WebIDLSerializer_Interface *Interface_p = Definition.data_p;

                for (int j = 0; j < Interface_p->Operations.length; ++j) 
                {
                    Nh_WebIDLSerializer_Operation *Operation_p = &((Nh_WebIDLSerializer_Operation*)Interface_p->Operations.bytes_p)[j];
                    fprintf(
                        File_p, 
                        "\n    Nh_WebIDL_Result Nh_%s_%s(\n        Nh_WebIDL_Object *This_p, Nh_List Arguments\n    );\n", 
                        fragmentName_p, Operation_p->name_p
                    );
                }
                break;
            }
            case NH_WEBIDL_SERIALIZER_DEFINITION_INTERFACE_MIXIN    : break; 
            case NH_WEBIDL_SERIALIZER_DEFINITION_MIXIN              : break;
            case NH_WEBIDL_SERIALIZER_DEFINITION_NAMESPACE          : break;
            case NH_WEBIDL_SERIALIZER_DEFINITION_PARTIAL            : break;
            case NH_WEBIDL_SERIALIZER_DEFINITION_DICTIONARY         : break; 
            case NH_WEBIDL_SERIALIZER_DEFINITION_ENUM               : break;
            case NH_WEBIDL_SERIALIZER_DEFINITION_TYPEDEF            : break;
            case NH_WEBIDL_SERIALIZER_DEFINITION_INCLUDES_STATEMENT : break;
        }    
    }

NH_WEBIDL_SERIALIZER_DIAGNOSTIC_END(NH_WEBIDL_SERIALIZER_SUCCESS)
}

static NH_WEBIDL_SERIALIZER_RESULT Nh_WebIDLSerializer_closeFile(
    FILE *File_p)
{
NH_WEBIDL_SERIALIZER_BEGIN()

    fprintf(File_p,"\n/** @} */\n\n#endif");
    fclose(File_p);

NH_WEBIDL_SERIALIZER_DIAGNOSTIC_END(NH_WEBIDL_SERIALIZER_SUCCESS)
}

// MAIN ============================================================================================

static NH_BYTE *inclOut_p = NULL;
static NH_BYTE *declOut_p = NULL;

NH_WEBIDL_SERIALIZER_RESULT Nh_WebIDLSerializer_main(
    int argc, NH_BYTE **argv_pp)
{
NH_WEBIDL_SERIALIZER_BEGIN()

    NH_BYTE wrkDir_p[2048] = {'\0'};
    getcwd(wrkDir_p, 2048);

    for (int i = 1; i < argc; ++i) 
    {
        if (strstr(argv_pp[i], "incl_out:")) {
            inclOut_p = argv_pp[i] + 9;
            continue;
        }
        else if (strstr(argv_pp[i], "decl_out:")) {
            declOut_p = argv_pp[i] + 9;
            continue;
        }

printf("%s\n", argv_pp[i]);

        Nh_WebIDLSerializer_SerializationData Data = Nh_WebIDLSerializer_serialize(argv_pp[i], NULL);

        FILE *File_p;
        NH_BYTE fragmentName_p[1024] = {'\0'};
        Nh_WebIDLSerializer_getFragmentName(argv_pp[i], fragmentName_p);

        NH_WEBIDL_SERIALIZER_CHECK(Nh_WebIDLSerializer_openDeclFile(&File_p, fragmentName_p, declOut_p))
        NH_WEBIDL_SERIALIZER_CHECK(Nh_WebIDLSerializer_generateDeclFile(File_p, fragmentName_p, Data.Fragment))
        NH_WEBIDL_SERIALIZER_CHECK(Nh_WebIDLSerializer_closeFile(File_p))

        NH_WEBIDL_SERIALIZER_CHECK(Nh_WebIDLSerializer_openHexdFile(&File_p, fragmentName_p, argv_pp[i]))
        NH_WEBIDL_SERIALIZER_CHECK(Nh_WebIDLSerializer_generateHexdFile(File_p, &Data.Buffer, fragmentName_p))
        NH_WEBIDL_SERIALIZER_CHECK(Nh_WebIDLSerializer_closeFile(File_p))
    }

NH_WEBIDL_SERIALIZER_DIAGNOSTIC_END(NH_WEBIDL_SERIALIZER_SUCCESS)
}

int main(
    int argc, NH_BYTE **argv_pp)
{
NH_WEBIDL_SERIALIZER_BEGIN()
NH_WEBIDL_SERIALIZER_DIAGNOSTIC_END(Nh_WebIDLSerializer_main(argc, argv_pp))
} 

//static void (*serializationCallback_f)(NH_BYTE *message_p) = NULL;
//static NH_WEBIDL_SERIALIZER_BINDING genBinding;
//
//NH_WEBIDL_SERIALIZER_RESULT Nh_WebIDLSerializer_beginGenerator(
//    void (*callback_f)(NH_BYTE *message_p), NH_WEBIDL_SERIALIZER_BINDING binding)
//{
//NH_WEBIDL_SERIALIZER_BEGIN()
//
//    serializationCallback_f = callback_f;
//    genBinding = binding;
//
//NH_WEBIDL_SERIALIZER_DIAGNOSTIC_END(NH_WEBIDL_SERIALIZER_SUCCESS)
//}
//
//NH_WEBIDL_SERIALIZER_RESULT Nh_WebIDLSerializer_generate(
//    NH_BYTE *outdir_p, NH_BYTE *filepath_p)
//{
//NH_WEBIDL_SERIALIZER_BEGIN()
//
//    Nh_WebIDLSerializer_SerializationData Data = Nh_WebIDLSerializer_serialize(filepath_p, serializationCallback_f);
//
//    FILE *File_p;
//    NH_BYTE fragmentName_p[1024] = {'\0'};
//    Nh_WebIDLSerializer_getFragmentName(filepath_p, fragmentName_p);
//
//    NH_WEBIDL_SERIALIZER_CHECK(Nh_WebIDLSerializer_openDeclFile(&File_p, fragmentName_p, outdir_p, genBinding))
//    NH_WEBIDL_SERIALIZER_CHECK(Nh_WebIDLSerializer_generateDeclFile(File_p, fragmentName_p, Data.Fragment, genBinding))
//    NH_WEBIDL_SERIALIZER_CHECK(Nh_WebIDLSerializer_closeFile(File_p))
//
//    NH_WEBIDL_SERIALIZER_CHECK(Nh_WebIDLSerializer_openHexdFile(&File_p, fragmentName_p, filepath_p, genBinding))
//    NH_WEBIDL_SERIALIZER_CHECK(Nh_WebIDLSerializer_generateHexdFile(File_p, &Data.Buffer, fragmentName_p, genBinding))
//    NH_WEBIDL_SERIALIZER_CHECK(Nh_WebIDLSerializer_closeFile(File_p))
//
//    files_pp[fileCount] = malloc(sizeof(NH_BYTE) * (strlen(filepath_p) + 1));
//    NH_WEBIDL_SERIALIZER_CHECK_MEM(files_pp[fileCount])
//
//    strcpy(files_pp[fileCount++], filepath_p);
//    SerializationData_p[serializationDataCount++] = Data;
//
//NH_WEBIDL_SERIALIZER_DIAGNOSTIC_END(NH_WEBIDL_SERIALIZER_SUCCESS)
//}
//
//NH_WEBIDL_SERIALIZER_RESULT Nh_WebIDLSerializer_endGenerator(
//    NH_BYTE *runtimepath_p)
//{
//NH_WEBIDL_SERIALIZER_BEGIN()
//
//    Nh_WebIDLSerializer_createBindData(runtimepath_p, genBinding);
//
//    for (int i = 0; i < serializationDataCount; ++i) {
//        Nh_WebIDLSerializer_freeSerializationData(SerializationData_p[i]);
//    } 
//    serializationDataCount = 0;
//
//    for (int i = 0; i < fileCount; ++i) {
//        free(files_pp[i]);
//        files_pp[i] = NULL;
//    } 
//    fileCount = 0;
//
//    serializationCallback_f = NULL;
//
//NH_WEBIDL_SERIALIZER_DIAGNOSTIC_END(NH_WEBIDL_SERIALIZER_SUCCESS)
//}
//
